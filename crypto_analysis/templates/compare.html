{% extends 'base.html' %}

{% block title %}مقارنة العملات الرقمية{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col-12">
        <nav aria-label="breadcrumb">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/">الرئيسية</a></li>
                <li class="breadcrumb-item active">مقارنة العملات</li>
            </ol>
        </nav>
    </div>
</div>

<div class="row mb-4">
    <div class="col-12">
        <div class="card animate__animated animate__fadeIn">
            <div class="card-header bg-info text-white">
                <h4 class="mb-0"><i class="fas fa-balance-scale me-2"></i>مقارنة العملات الرقمية</h4>
            </div>
            <div class="card-body">
                <form method="post" class="row g-3">
                    <div class="col-md-6">
                        <label for="symbols" class="form-label">اختر العملات للمقارنة (2-5 عملات)</label>
                        <select class="form-select select2" id="symbols" name="symbols" multiple required>
                            {% for symbol, crypto in crypto_data.items() %}
                            <option value="{{ symbol }}" {% if symbol in selected_symbols %}selected{% endif %}>
                                {{ crypto.name }} ({{ symbol }})
                            </option>
                            {% endfor %}
                        </select>
                        <div class="form-text">
                            <i class="fas fa-info-circle me-1"></i>يمكنك اختيار من 2 إلى 5 عملات للمقارنة
                        </div>
                    </div>
                    
                    <div class="col-md-3">
                        <label for="days" class="form-label">فترة المقارنة</label>
                        <select class="form-select" id="days" name="days">
                            <option value="7">7 أيام</option>
                            <option value="14">14 يوم</option>
                            <option value="30" selected>30 يوم</option>
                            <option value="90">90 يوم</option>
                            <option value="180">180 يوم</option>
                            <option value="365">سنة</option>
                        </select>
                    </div>
                    
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-info w-100">
                            <i class="fas fa-balance-scale me-2"></i>مقارنة
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Modal: اختيار عملتين على الأقل -->
<div class="modal fade" id="selectTwoModal" tabindex="-1" aria-labelledby="selectTwoModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-warning text-dark">
        <h5 class="modal-title" id="selectTwoModalLabel"><i class="fas fa-exclamation-triangle me-2"></i>تنبيه</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
      </div>
      <div class="modal-body">
        يجب اختيار عملتين على الأقل لإجراء المقارنة. الرجاء اختيار 2 إلى 5 عملات والمحاولة مرة أخرى.
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-warning" data-bs-dismiss="modal">حسنًا</button>
      </div>
    </div>
  </div>
</div>

{% if comparison_charts %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card animate__animated animate__fadeIn">
            <div class="card-header">
                <ul class="nav nav-tabs card-header-tabs" id="comparisonTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="price-tab" data-bs-toggle="tab" data-bs-target="#price-tab-pane" type="button" role="tab" aria-controls="price-tab-pane" aria-selected="true">
                            <i class="fas fa-chart-line me-1"></i>مقارنة الأداء
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="volatility-tab" data-bs-toggle="tab" data-bs-target="#volatility-tab-pane" type="button" role="tab" aria-controls="volatility-tab-pane" aria-selected="false">
                            <i class="fas fa-chart-bar me-1"></i>مقارنة التقلب
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="correlation-tab" data-bs-toggle="tab" data-bs-target="#correlation-tab-pane" type="button" role="tab" aria-controls="correlation-tab-pane" aria-selected="false">
                            <i class="fas fa-project-diagram me-1"></i>مصفوفة الارتباط
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="risk-return-tab" data-bs-toggle="tab" data-bs-target="#risk-return-tab-pane" type="button" role="tab" aria-controls="risk-return-tab-pane" aria-selected="false">
                            <i class="fas fa-chart-scatter me-1"></i>المخاطر والعوائد
                        </button>
                    </li>
                </ul>
            </div>
            <div class="card-body">
                <div class="tab-content" id="comparisonTabsContent">
                    <div class="tab-pane fade show active" id="price-tab-pane" role="tabpanel" aria-labelledby="price-tab" tabindex="0">
                        <div id="price-chart" class="chart-container plotly-chart"></div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>يوضح هذا الرسم البياني نسبة التغير في أسعار العملات المختارة خلال الفترة المحددة، بدءًا من نفس النقطة (0%) لتسهيل المقارنة.</span>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="volatility-tab-pane" role="tabpanel" aria-labelledby="volatility-tab" tabindex="0">
                        <div id="volatility-chart" class="chart-container plotly-chart"></div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>يوضح هذا الرسم البياني مقارنة لتقلب العملات المختارة خلال الفترة المحددة. التقلب هو مقياس للانحراف المعياري للعوائد اليومية، وكلما كان التقلب أعلى كلما كانت المخاطر أكبر.</span>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="correlation-tab-pane" role="tabpanel" aria-labelledby="correlation-tab" tabindex="0">
                        <div id="correlation-chart" class="chart-container plotly-chart"></div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>توضح مصفوفة الارتباط مدى ارتباط العملات المختارة ببعضها البعض. القيم القريبة من 1 تشير إلى ارتباط إيجابي قوي، والقيم القريبة من -1 تشير إلى ارتباط سلبي قوي، والقيم القريبة من 0 تشير إلى عدم وجود ارتباط.</span>
                        </div>
                    </div>
                    <div class="tab-pane fade" id="risk-return-tab-pane" role="tabpanel" aria-labelledby="risk-return-tab" tabindex="0">
                        <div id="risk-return-chart" class="chart-container plotly-chart"></div>
                        <div class="alert alert-info mt-3">
                            <i class="fas fa-info-circle me-2"></i>
                            <span>يوضح هذا الرسم البياني العلاقة بين المخاطر (التقلب) والعوائد لكل عملة. العملات في الجزء العلوي الأيسر تقدم أفضل نسبة مخاطر/عوائد (مخاطر أقل وعوائد أعلى).</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% if comparison_summary %}
<div class="row mb-4">
    <div class="col-12">
        <div class="card animate__animated animate__fadeIn">
            <div class="card-header bg-primary text-white">
                <h4 class="mb-0"><i class="fas fa-chart-pie me-2"></i>ملخص المقارنة ({{ comparison_summary.period }} يوم)</h4>
            </div>
            <div class="card-body">
                <div class="row mb-4">
                    <div class="col-md-3" data-aos="fade-up">
                        <div class="card h-100 border-success">
                            <div class="card-header bg-success text-white">
                                <h5 class="mb-0">أفضل أداء</h5>
                            </div>
                            <div class="card-body text-center">
                                <h4>{{ comparison_summary.best_performer.name }}</h4>
                                <h6 class="text-muted">{{ comparison_summary.best_performer.symbol }}</h6>
                                <div class="mt-3">
                                    <h3 class="text-success">
                                        <i class="fas fa-arrow-up me-1"></i>{{ "%.2f"|format(comparison_summary.best_performer.price_change) }}%
                                    </h3>
                                    <p class="mb-0">التغير خلال الفترة</p>
                                </div>
                                <div class="mt-3">
                                    <a href="/crypto/{{ comparison_summary.best_performer.symbol }}" class="btn btn-sm btn-outline-success">
                                        <i class="fas fa-info-circle me-1"></i>التفاصيل
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3" data-aos="fade-up" data-aos-delay="100">
                        <div class="card h-100 border-danger">
                            <div class="card-header bg-danger text-white">
                                <h5 class="mb-0">أسوأ أداء</h5>
                            </div>
                            <div class="card-body text-center">
                                <h4>{{ comparison_summary.worst_performer.name }}</h4>
                                <h6 class="text-muted">{{ comparison_summary.worst_performer.symbol }}</h6>
                                <div class="mt-3">
                                    <h3 class="text-danger">
                                        <i class="fas fa-arrow-down me-1"></i>{{ "%.2f"|format(comparison_summary.worst_performer.price_change|abs) }}%
                                    </h3>
                                    <p class="mb-0">التغير خلال الفترة</p>
                                </div>
                                <div class="mt-3">
                                    <a href="/crypto/{{ comparison_summary.worst_performer.symbol }}" class="btn btn-sm btn-outline-danger">
                                        <i class="fas fa-info-circle me-1"></i>التفاصيل
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3" data-aos="fade-up" data-aos-delay="200">
                        <div class="card h-100 border-info">
                            <div class="card-header bg-info text-white">
                                <h5 class="mb-0">الأقل تقلبًا</h5>
                            </div>
                            <div class="card-body text-center">
                                <h4>{{ comparison_summary.least_volatile.name }}</h4>
                                <h6 class="text-muted">{{ comparison_summary.least_volatile.symbol }}</h6>
                                <div class="mt-3">
                                    <h3 class="text-info">
                                        {{ "%.2f"|format(comparison_summary.least_volatile.volatility) }}%
                                    </h3>
                                    <p class="mb-0">التقلب (الانحراف المعياري)</p>
                                </div>
                                <div class="mt-3">
                                    <a href="/crypto/{{ comparison_summary.least_volatile.symbol }}" class="btn btn-sm btn-outline-info">
                                        <i class="fas fa-info-circle me-1"></i>التفاصيل
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-3" data-aos="fade-up" data-aos-delay="300">
                        <div class="card h-100 border-primary">
                            <div class="card-header bg-primary text-white">
                                <h5 class="mb-0">أفضل نسبة مخاطر/عوائد</h5>
                            </div>
                            <div class="card-body text-center">
                                <h4>{{ comparison_summary.best_sharpe.name }}</h4>
                                <h6 class="text-muted">{{ comparison_summary.best_sharpe.symbol }}</h6>
                                <div class="mt-3">
                                    <h3 class="text-primary">
                                        {{ "%.2f"|format(comparison_summary.best_sharpe.sharpe_ratio) }}
                                    </h3>
                                    <p class="mb-0">نسبة شارب</p>
                                </div>
                                <div class="mt-3">
                                    <a href="/crypto/{{ comparison_summary.best_sharpe.symbol }}" class="btn btn-sm btn-outline-primary">
                                        <i class="fas fa-info-circle me-1"></i>التفاصيل
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="table-responsive">
                    <table class="comparison-table">
                        <thead>
                            <tr>
                                <th>العملة</th>
                                <th>السعر الحالي</th>
                                <th>التغير خلال الفترة</th>
                                <th>متوسط العائد اليومي</th>
                                <th>التقلب</th>
                                <th>أقصى انخفاض</th>
                                <th>نسبة شارب</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in comparison_summary.comparison_data %}
                            <tr>
                                <td>
                                    <div class="d-flex align-items-center">
                                        <div class="me-2">
                                            {% if crypto_data[item.symbol].image %}
                                            <img src="{{ crypto_data[item.symbol].image }}" alt="{{ item.name }}" width="24" height="24">
                                            {% else %}
                                            <i class="fas fa-coins" style="color: {{ crypto_data[item.symbol].color }};"></i>
                                            {% endif %}
                                        </div>
                                        <div>
                                            <strong>{{ item.name }}</strong>
                                            <small class="text-muted d-block">{{ item.symbol }}</small>
                                        </div>
                                    </div>
                                </td>
                                <td>${{ "%.2f"|format(item.current_price) }}</td>
                                <td class="{{ 'text-success' if item.price_change > 0 else 'text-danger' }}">
                                    <i class="fas {{ 'fa-arrow-up' if item.price_change > 0 else 'fa-arrow-down' }}"></i>
                                    {{ "%.2f"|format(item.price_change|abs) }}%
                                </td>
                                <td class="{{ 'text-success' if item.avg_daily_return > 0 else 'text-danger' }}">
                                    {{ "%.2f"|format(item.avg_daily_return) }}%
                                </td>
                                <td>{{ "%.2f"|format(item.volatility) }}%</td>
                                <td class="text-danger">{{ "%.2f"|format(item.max_drawdown|abs) }}%</td>
                                <td>{{ "%.2f"|format(item.sharpe_ratio) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                
                <div class="alert alert-info mt-4">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>ملاحظة:</strong> نسبة شارب هي مقياس للعائد المعدل بالمخاطر، وتحسب بقسمة متوسط العائد اليومي على التقلب. كلما كانت النسبة أعلى، كان أداء العملة أفضل من حيث العائد مقابل المخاطر.
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endif %}

<div class="row">
    <div class="col-12">
        <div class="card animate__animated animate__fadeIn">
            <div class="card-header">
                <h4 class="mb-0"><i class="fas fa-info-circle me-2"></i>حول مقارنة العملات</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6" data-aos="fade-up">
                        <h5><i class="fas fa-chart-line me-2" style="color: var(--primary-color);"></i>مقارنة الأداء</h5>
                        <p>تتيح لك هذه الميزة مقارنة أداء العملات الرقمية المختلفة خلال فترة زمنية محددة. يتم عرض نسبة التغير في الأسعار بدءًا من نفس النقطة (0%) لتسهيل المقارنة بين العملات ذات الأسعار المختلفة.</p>
                        
                        <h5 class="mt-4"><i class="fas fa-chart-bar me-2" style="color: var(--success-color);"></i>مقارنة التقلب</h5>
                        <p>التقلب هو مقياس لمدى تغير سعر العملة خلال فترة زمنية معينة. يتم حسابه باستخدام الانحراف المعياري للعوائد اليومية. كلما كان التقلب أعلى، كلما كانت المخاطر أكبر.</p>
                    </div>
                    <div class="col-md-6" data-aos="fade-up" data-aos-delay="100">
                        <h5><i class="fas fa-project-diagram me-2" style="color: var(--danger-color);"></i>مصفوفة الارتباط</h5>
                        <p>توضح مصفوفة الارتباط مدى ارتباط العملات المختلفة ببعضها البعض. الارتباط الإيجابي (قريب من 1) يعني أن العملات تتحرك في نفس الاتجاه، والارتباط السلبي (قريب من -1) يعني أنها تتحرك في اتجاهات متعاكسة.</p>
                        
                        <h5 class="mt-4"><i class="fas fa-balance-scale me-2" style="color: var(--info-color);"></i>المخاطر والعوائد</h5>
                        <p>يوضح هذا التحليل العلاقة بين المخاطر (التقلب) والعوائد لكل عملة. العملات ذات العوائد العالية والتقلب المنخفض تعتبر أفضل من حيث نسبة المخاطر/العوائد، وهو ما يقاس بنسبة شارب.</p>
                    </div>
                </div>
                
                <hr class="my-4">
                
                <div class="row mt-3">
                    <div class="col-md-3 text-center" data-aos="fade-up" data-aos-delay="200">
                        <div class="p-3">
                            <i class="fas fa-chart-line fa-3x mb-3" style="color: var(--primary-color);"></i>
                            <h5>مقارنة الأداء</h5>
                            <p>قارن أداء العملات المختلفة خلال فترات زمنية مختلفة</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center" data-aos="fade-up" data-aos-delay="300">
                        <div class="p-3">
                            <i class="fas fa-chart-bar fa-3x mb-3" style="color: var(--success-color);"></i>
                            <h5>تحليل التقلب</h5>
                            <p>قياس وتحليل تقلب العملات المختلفة لتقييم المخاطر</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center" data-aos="fade-up" data-aos-delay="400">
                        <div class="p-3">
                            <i class="fas fa-project-diagram fa-3x mb-3" style="color: var(--danger-color);"></i>
                            <h5>تحليل الارتباط</h5>
                            <p>فهم العلاقات بين العملات المختلفة وتنويع المحفظة</p>
                        </div>
                    </div>
                    <div class="col-md-3 text-center" data-aos="fade-up" data-aos-delay="500">
                        <div class="p-3">
                            <i class="fas fa-balance-scale fa-3x mb-3" style="color: var(--info-color);"></i>
                            <h5>تحليل المخاطر/العوائد</h5>
                            <p>تقييم العملات من حيث العائد المعدل بالمخاطر</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    $(document).ready(function() {
        // تهيئة Select2
        $('.select2').select2({
            dir: "rtl",
            language: "ar",
            placeholder: "اختر العملات للمقارنة",
            width: '100%',
            maximumSelectionLength: 5,
            minimumSelectionLength: 2
        });

        // التحقق من عدد العملات المختارة
        $('#symbols').on('change', function() {
            var selectedCount = $(this).val() ? $(this).val().length : 0;

            if (selectedCount < 2) {
                $('.select2-selection').css('border-color', '#dc3545');
                $(this).closest('.col-md-6').find('.form-text').html('<i class="fas fa-exclamation-triangle me-1 text-danger"></i>يجب اختيار عملتين على الأقل');
            } else if (selectedCount > 5) {
                $('.select2-selection').css('border-color', '#dc3545');
                $(this).closest('.col-md-6').find('.form-text').html('<i class="fas fa-exclamation-triangle me-1 text-danger"></i>يمكنك اختيار 5 عملات كحد أقصى');
            } else {
                $('.select2-selection').css('border-color', '#ced4da');
                $(this).closest('.col-md-6').find('.form-text').html('<i class="fas fa-info-circle me-1"></i>يمكنك اختيار من 2 إلى 5 عملات للمقارنة');
            }
        });

        // منع الإرسال عند اختيار أقل من عملتين وإظهار نافذة منبثقة
        $('form').on('submit', function(e) {
            var selected = $('#symbols').val();
            var count = selected ? selected.length : 0;
            if (count < 2) {
                e.preventDefault();
                var modal = new bootstrap.Modal(document.getElementById('selectTwoModal'));
                modal.show();
            }
        });
    });
</script>

{% if comparison_charts %}
<script>
    var cfg = {responsive: true, displayModeBar: false};

    // رسم بياني لمقارنة الأداء
    var priceChartData = {{ comparison_charts.price|safe }};
    Plotly.newPlot('price-chart', priceChartData.data, priceChartData.layout, cfg);
    
    // رسم بياني لمقارنة التقلب
    var volatilityChartData = {{ comparison_charts.volatility|safe }};
    Plotly.newPlot('volatility-chart', volatilityChartData.data, volatilityChartData.layout, cfg);
    
    // رسم بياني لمصفوفة الارتباط
    var correlationChartData = {{ comparison_charts.correlation|safe }};
    Plotly.newPlot('correlation-chart', correlationChartData.data, correlationChartData.layout, cfg);
    
    // رسم بياني للمخاطر والعوائد
    var riskReturnChartData = {{ comparison_charts.risk_return|safe }};
    Plotly.newPlot('risk-return-chart', riskReturnChartData.data, riskReturnChartData.layout, cfg);
    
    // جعل الرسوم البيانية متجاوبة
    window.addEventListener('resize', function() {
        Plotly.relayout('price-chart', {'xaxis.autorange': true, 'yaxis.autorange': true});
        Plotly.relayout('volatility-chart', {'xaxis.autorange': true, 'yaxis.autorange': true});
        Plotly.relayout('correlation-chart', {'xaxis.autorange': true, 'yaxis.autorange': true});
        Plotly.relayout('risk-return-chart', {'xaxis.autorange': true, 'yaxis.autorange': true});
    });
    
    // تحديث الرسوم البيانية عند تغيير التبويب
    $('button[data-bs-toggle="tab"]').on('shown.bs.tab', function () {
        window.dispatchEvent(new Event('resize'));
    });
</script>
{% endif %}
{% endblock %}